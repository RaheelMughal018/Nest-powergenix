generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
}

enum ItemType {
  RAW
  FINAL
}

enum AccountType {
  BANK
  JAZZCASH
  EASYPAISA
  IN_HAND
}

enum PaymentStatus {
  PAID
  UNPAID
  PARTIAL
}

enum LedgerEntityType {
  SUPPLIER
  CUSTOMER
  ACCOUNT
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum ProductionStatus {
  DRAFT
  IN_PROCESS
  DONE
}

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique @db.VarChar(255)
  password   String   @db.VarChar(255)
  name       String   @db.VarChar(255)
  phone      String?  @db.VarChar(50)
  role       UserRole @default(ADMIN)
  is_active  Boolean  @default(true) @map("is_active")
  created_at DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updated_at DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  stock_adjustments StockAdjustment[]
  purchase_invoices PurchaseInvoice[]
  payments          Payment[]
  productions       Production[]
  expenses          Expense[]

  @@index([email])
  @@map("users")
}

model Supplier {
  id              Int      @id @default(autoincrement())
  name            String
  company_name    String?  @map("company_name")
  phone           String?
  address         String?
  opening_balance Decimal  @default(0) @map("opening_balance") @db.Decimal(15, 2)
  current_balance Decimal  @default(0) @map("current_balance") @db.Decimal(15, 2)
  created_at      DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updated_at      DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  purchase_invoices PurchaseInvoice[]
  payments          Payment[]
  ledger_entries    LedgerEntry[]

  @@map("suppliers")
}

model Customer {
  id              Int      @id @default(autoincrement())
  name            String
  company_name    String?  @map("company_name")
  phone           String?
  address         String?
  opening_balance Decimal  @default(0) @map("opening_balance") @db.Decimal(15, 2)
  current_balance Decimal  @default(0) @map("current_balance") @db.Decimal(15, 2)
  created_at      DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updated_at      DateTime @updatedAt @db.Timestamp(6)

  ledger_entries LedgerEntry[]

  @@map("customers")
}

model Category {
  id         Int      @id @default(autoincrement())
  name       String   @unique @db.VarChar(100)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  items Item[]

  @@map("categories")
}

model Item {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  item_type   ItemType
  category_id Int
  category    Category @relation(fields: [category_id], references: [id], onDelete: Restrict)
  quantity    Decimal  @default(0) @db.Decimal(15, 3)
  avg_price   Decimal  @default(0) @db.Decimal(15, 2)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  stock_adjustments      StockAdjustment[]
  purchase_invoice_items PurchaseInvoiceItem[]

  // Recipe relations
  recipe             Recipe?            @relation("RecipeFinalProduct")
  recipe_ingredients RecipeIngredient[] @relation("RecipeIngredientItem")

  // Production relations
  production_items       ProductionItem[]       @relation("ProductionFinalItem")
  production_ingredients ProductionIngredient[] @relation("ProductionIngredientItem")

  @@unique([category_id, name])
  @@index([category_id])
  @@index([item_type])
  @@map("items")
}

model StockAdjustment {
  id              Int      @id @default(autoincrement())
  item_id         Int
  item            Item     @relation(fields: [item_id], references: [id])
  admin_id        Int
  admin           User     @relation(fields: [admin_id], references: [id])
  quantity        Decimal  @db.Decimal(15, 3)
  avg_price       Decimal  @db.Decimal(15, 2)
  reason          String
  notes           String?
  adjustment_date DateTime @default(now())
  created_at      DateTime @default(now())

  purchase_invoice_id Int?
  purchase_invoice    PurchaseInvoice? @relation(fields: [purchase_invoice_id], references: [id], onDelete: SetNull)

  production_id Int?
  production    Production? @relation(fields: [production_id], references: [id], onDelete: SetNull)

  @@map("stock_adjustments")
}

model Account {
  id              Int         @id @default(autoincrement())
  name            String      @db.VarChar(100)
  account_type    AccountType
  account_number  String?     @db.VarChar(50)
  bank_name       String?     @db.VarChar(100)
  opening_balance Decimal     @default(0) @db.Decimal(15, 2)
  current_balance Decimal     @default(0) @db.Decimal(15, 2)
  created_at      DateTime    @default(now()) @db.Timestamp(6)
  updated_at      DateTime    @updatedAt @db.Timestamp(6)

  payments       Payment[]
  ledger_entries LedgerEntry[]
  expenses       Expense[]

  @@map("accounts")
}

model PurchaseInvoice {
  id             Int           @id @default(autoincrement())
  invoice_number String        @unique @db.VarChar(50)
  supplier_id    Int
  supplier       Supplier      @relation(fields: [supplier_id], references: [id], onDelete: Restrict)
  admin_id       Int
  admin          User          @relation(fields: [admin_id], references: [id], onDelete: Restrict)
  invoice_date   DateTime      @default(now()) @db.Timestamp(6)
  due_date       DateTime?     @db.Timestamp(6)
  subtotal       Decimal       @db.Decimal(15, 2)
  tax            Decimal       @default(0) @db.Decimal(15, 2)
  discount       Decimal       @default(0) @db.Decimal(15, 2)
  total_amount   Decimal       @db.Decimal(15, 2)
  paid_amount    Decimal       @default(0) @db.Decimal(15, 2)
  payment_status PaymentStatus @default(UNPAID)
  notes          String?
  created_at     DateTime      @default(now()) @db.Timestamp(6)
  updated_at     DateTime      @updatedAt @db.Timestamp(6)

  items             PurchaseInvoiceItem[]
  payments          Payment[]
  stock_adjustments StockAdjustment[]
  ledger_entries    LedgerEntry[]

  @@index([supplier_id])
  @@index([invoice_date])
  @@index([payment_status])
  @@map("purchase_invoices")
}

model PurchaseInvoiceItem {
  id                  Int             @id @default(autoincrement())
  purchase_invoice_id Int
  purchase_invoice    PurchaseInvoice @relation(fields: [purchase_invoice_id], references: [id], onDelete: Cascade)
  item_id             Int
  item                Item            @relation(fields: [item_id], references: [id], onDelete: Restrict)
  quantity            Decimal         @db.Decimal(15, 3)
  unit_price          Decimal         @db.Decimal(15, 2)
  total_price         Decimal         @db.Decimal(15, 2)
  created_at          DateTime        @default(now()) @db.Timestamp(6)

  @@index([purchase_invoice_id])
  @@index([item_id])
  @@map("purchase_invoice_items")
}

model Payment {
  id                  Int              @id @default(autoincrement())
  payment_number      String           @unique @db.VarChar(50)
  supplier_id         Int
  supplier            Supplier         @relation(fields: [supplier_id], references: [id], onDelete: Restrict)
  account_id          Int
  account             Account          @relation(fields: [account_id], references: [id], onDelete: Restrict)
  admin_id            Int
  admin               User             @relation(fields: [admin_id], references: [id], onDelete: Restrict)
  amount              Decimal          @db.Decimal(15, 2)
  payment_date        DateTime         @default(now()) @db.Timestamp(6)
  purchase_invoice_id Int?
  purchase_invoice    PurchaseInvoice? @relation(fields: [purchase_invoice_id], references: [id], onDelete: SetNull)
  notes               String?
  created_at          DateTime         @default(now()) @db.Timestamp(6)
  updated_at          DateTime         @updatedAt @db.Timestamp(6)

  ledger_entries LedgerEntry[]

  @@index([supplier_id])
  @@index([account_id])
  @@index([payment_date])
  @@map("payments")
}

model LedgerEntry {
  id                  Int              @id @default(autoincrement())
  entity_type         LedgerEntityType
  supplier_id         Int?
  supplier            Supplier?        @relation(fields: [supplier_id], references: [id], onDelete: Cascade)
  customer_id         Int?
  customer            Customer?        @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  account_id          Int?
  account             Account?         @relation(fields: [account_id], references: [id], onDelete: Cascade)
  transaction_type    TransactionType
  amount              Decimal          @db.Decimal(15, 2)
  balance             Decimal          @db.Decimal(15, 2)
  description         String
  reference_number    String?          @db.VarChar(50)
  transaction_date    DateTime         @default(now()) @db.Timestamp(6)
  purchase_invoice_id Int?
  purchase_invoice    PurchaseInvoice? @relation(fields: [purchase_invoice_id], references: [id], onDelete: SetNull)
  payment_id          Int?
  payment             Payment?         @relation(fields: [payment_id], references: [id], onDelete: SetNull)
  expense_id          Int?
  expense             Expense?          @relation(fields: [expense_id], references: [id], onDelete: SetNull)
  created_at          DateTime         @default(now()) @db.Timestamp(6)

  @@index([supplier_id])
  @@index([customer_id])
  @@index([account_id])
  @@index([transaction_date])
  @@map("ledger_entries")
}

// ============================================
// RECIPE MODULE
// ============================================

model Recipe {
  id               Int      @id @default(autoincrement())
  final_product_id Int      @unique
  final_product    Item     @relation("RecipeFinalProduct", fields: [final_product_id], references: [id], onDelete: Restrict)
  name             String   @db.VarChar(255)
  description      String?
  created_at       DateTime @default(now()) @db.Timestamp(6)
  updated_at       DateTime @updatedAt @db.Timestamp(6)

  ingredients RecipeIngredient[]
  productions Production[]

  @@map("recipes")
}

model RecipeIngredient {
  id        Int     @id @default(autoincrement())
  recipe_id Int
  recipe    Recipe  @relation(fields: [recipe_id], references: [id], onDelete: Cascade)
  item_id   Int
  item      Item    @relation("RecipeIngredientItem", fields: [item_id], references: [id], onDelete: Restrict)
  // Base quantity per unit of final product
  quantity   Decimal  @db.Decimal(15, 3)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  // One item can only appear once per recipe
  @@unique([recipe_id, item_id])
  @@index([recipe_id])
  @@index([item_id])
  @@map("recipe_ingredients")
}

// ============================================
// PRODUCTION MODULE
// ============================================

model Production {
  id           Int              @id @default(autoincrement())
  batch_number String           @unique @db.VarChar(50)
  recipe_id    Int
  recipe       Recipe           @relation(fields: [recipe_id], references: [id], onDelete: Restrict)
  admin_id     Int
  admin        User             @relation(fields: [admin_id], references: [id], onDelete: Restrict)
  quantity     Int
  status       ProductionStatus @default(DRAFT)

  // Locked when production moves to DONE
  total_cost    Decimal @default(0) @db.Decimal(15, 2)
  cost_per_unit Decimal @default(0) @db.Decimal(15, 2)

  start_date      DateTime? @db.Timestamp(6)
  completion_date DateTime? @db.Timestamp(6)
  notes           String?

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  // Production-level ingredient overrides
  // Copied from recipe at creation, modifiable until DONE
  production_ingredients ProductionIngredient[]
  production_items       ProductionItem[]
  stock_adjustments      StockAdjustment[]

  @@index([recipe_id])
  @@index([status])
  @@map("productions")
}

model ProductionIngredient {
  id            Int        @id @default(autoincrement())
  production_id Int
  production    Production @relation(fields: [production_id], references: [id], onDelete: Cascade)
  item_id       Int
  item          Item       @relation("ProductionIngredientItem", fields: [item_id], references: [id], onDelete: Restrict)

  // Quantity per unit of final product
  // (total consumed = quantity Ã— production.quantity)
  quantity Decimal @db.Decimal(15, 3)

  // Was this copied from recipe or manually added?
  is_from_recipe Boolean @default(true)

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  // One item can only appear once per production
  @@unique([production_id, item_id])
  @@index([production_id])
  @@index([item_id])
  @@map("production_ingredients")
}

model ProductionItem {
  id            Int        @id @default(autoincrement())
  production_id Int
  production    Production @relation(fields: [production_id], references: [id], onDelete: Cascade)
  item_id       Int
  item          Item       @relation("ProductionFinalItem", fields: [item_id], references: [id], onDelete: Restrict)

  // Unique serial number for each physical unit
  serial_number String @unique @db.VarChar(100)

  // Cost locked at production completion time - NEVER changes
  cost_price Decimal @db.Decimal(15, 2)

  // Tracks if this unit has been sold
  is_sold Boolean @default(false)

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  @@index([production_id])
  @@index([item_id])
  @@index([serial_number])
  @@map("production_items")
}


model ExpenseCategory {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  expenses Expense[]

  @@map("expense_categories")
}

model Expense {
  id            Int             @id @default(autoincrement())
  category_id   Int
  category      ExpenseCategory @relation(fields: [category_id], references: [id], onDelete: Restrict)
  account_id    Int
  account       Account         @relation(fields: [account_id], references: [id], onDelete: Restrict)
  admin_id      Int
  admin         User            @relation(fields: [admin_id], references: [id], onDelete: Restrict)
  amount        Decimal         @db.Decimal(15, 2)
  description   String
  expense_date  DateTime        @default(now())
  notes         String?
  receipt_image String?
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt

  // Relations
  ledger_entries LedgerEntry[]

  @@map("expenses")
}